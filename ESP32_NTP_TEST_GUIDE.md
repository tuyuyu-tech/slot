# ESP32 NTP時刻取得テストガイド

## テスト目的
スマホのテザリング経由でESP32がNTPサーバーから正確な時刻を取得できるかを確認

## 事前準備

### 1. スマホのテザリング設定
```
iPhone設定例:
設定 → インターネット共有
- Wi-Fiパスワード: slotbot2024
- テザリング名: User's iPhone (または任意)
```

### 2. ESP32コード設定変更
`esp32_ntp_test.ino`の以下を変更：
```cpp
const char* ssid = "実際のテザリング名";        
const char* password = "実際のパスワード";      
```

## テスト手順

### ステップ1: テザリング開始
1. スマホでテザリングを開始
2. ESP32にコードをアップロード
3. シリアルモニター（115200 baud）を開く

### ステップ2: ESP32起動
ESP32起動後、以下の処理が順番に実行されます：

#### 1. WiFi接続テスト
```
--- WiFi接続テスト ---
接続先SSID: User's iPhone
WiFi接続中..........
✓ WiFi接続成功！
IP Address: 192.168.XXX.XXX
Signal Strength: -XX dBm
```

#### 2. NTP時刻同期テスト
```
--- NTP時刻同期テスト ---
NTPサーバー: ntp.nict.jp
NTP同期中..........
✓ NTP時刻同期成功！
取得時刻:
  日時: 2024/01/01 12:34:56
  Unix timestamp: 1704078896
  Unix timestamp(ms): 1704078896000
```

#### 3. WiFi切断テスト
```
--- WiFi切断テスト ---
WiFi切断実行...
✓ WiFi切断成功
```

#### 4. 時刻継続性テスト
```
--- 時刻継続性テスト ---
WiFi切断後も時刻が継続するかテスト中...
テスト1回目: 現在時刻: 2024/01/01 12:35:01 (Unix: 1704078901000 ms)
テスト2回目: 現在時刻: 2024/01/01 12:35:03 (Unix: 1704078903000 ms)
```

### ステップ3: 継続動作確認
テスト完了後、5秒ごとに現在時刻が表示され続けます：
```
現在時刻: 2024/01/01 12:35:08 (Unix: 1704078908000 ms)
現在時刻: 2024/01/01 12:35:13 (Unix: 1704078913000 ms)
```

## 期待される結果

### ✅ 成功パターン
- WiFi接続成功
- NTP同期成功（日本時間で正確な時刻表示）
- WiFi切断後も時刻継続
- Unix timestampが正確

### ❌ 失敗パターンと対処

#### WiFi接続失敗
```
❌ WiFi接続失敗
テザリング設定を確認してください:
1. スマホのテザリングがONか
2. SSID・パスワードが正しいか
```
**対処**: テザリング設定とコードのSSID/パスワードを再確認

#### NTP同期失敗
```
❌ NTP時刻同期失敗
インターネット接続を確認してください
```
**対処**: スマホのモバイルデータ通信を確認

## 次のステップ

### テスト成功時
- Unix timestamp(ms)が正確に取得できることを確認
- この値を使って絶対時刻指定のPRESSコマンド実装へ進む

### テスト失敗時
- エラーログを確認して原因特定
- 設定変更後に再テスト

## 重要なポイント

1. **時刻精度**: NTP同期により±10ms程度の精度
2. **WiFi不要**: 同期後はWiFi切断しても時刻継続
3. **電力効率**: 起動時のみWiFi使用、通常時はBLE運用可能
4. **Unix timestamp**: JavaScriptとの時刻共有に使用

このテストが成功すれば、ビタタイミング高精度同期の実装準備完了です！