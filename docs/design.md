# パチスロ動画ビタ押しタイミング認識システム 設計書

## 1. 要件定義書

### 1.1. 目的
パチスロ動画においてリール上の特定図柄を認識し、最適なビタ押しタイミングをユーザーに提示するシステムを開発する。

### 1.2. 機能要件
1. **画面キャプチャ機能**
   - 動画再生画面をリアルタイムでキャプチャする
   - フレームレートを安定させ、遅延を最小限に抑える

2. **図柄認識機能**
   - リール上の特定図柄を認識する
   - 複数の図柄を同時に認識・追跡できる
   - 異なる機種・解像度に対応できる

3. **タイミング計算機能**
   - リールの回転速度と位置を計算する
   - 目標図柄に対する最適なボタン押下タイミングを予測する
   - 機種ごとの特性（引き込み・すべり等）を考慮した補正を行う

4. **ユーザーインターフェース**
   - 認識された図柄とタイミング情報をリアルタイムで表示
   - 視覚的・音声的アラートによるタイミング通知
   - 図柄登録、感度調整などの設定画面提供

### 1.3. 非機能要件
1. **性能要件**
   - 30fps以上での処理速度確保
   - ビタ押しタイミングの精度±1フレーム以内
   - CPU使用率30%以下の軽量処理

2. **互換性要件**
   - Windows 10/11環境での動作保証
   - 主要な動画プレーヤー・配信サイトとの互換性

3. **拡張性要件**
   - 新機種対応のためのプラグイン式アーキテクチャ
   - ユーザーによる図柄テンプレート登録機能

## 2. システム設計書

### 2.1. システム概要
本システムは4つの主要モジュールから構成される：
1. 画面キャプチャモジュール
2. 図柄認識モジュール
3. タイミング計算モジュール
4. ユーザーインターフェースモジュール

これらのモジュールが連携し、リアルタイムでパチスロ動画を解析し、ビタ押しタイミングを通知する。

### 2.2. 機能詳細設計

#### 2.2.1. 画面キャプチャモジュール
- **スクリーンキャプチャ機能**
  - Win32 APIまたはDirectXを使用したスクリーンキャプチャ
  - 指定された領域のみをキャプチャする機能
  - フレームレート調整とバッファリング機能

- **プリプロセッシング機能**
  - 解像度統一・ノイズ削減等の前処理
  - リール領域の自動検出と切り出し

#### 2.2.2. 図柄認識モジュール
- **テンプレートマッチング機能**
  - 事前登録された図柄テンプレートとのマッチング
  - スケーリング・回転に対応したマッチングアルゴリズム

- **機械学習認識機能（オプション）**
  - CNNによる図柄認識
  - 学習モデルの保存と読み込み

- **トラッキング機能**
  - 認識された図柄の位置追跡
  - オプティカルフロー等を用いた動き予測

#### 2.2.3. タイミング計算モジュール
- **回転解析機能**
  - フレーム間の変化量からリール回転速度算出
  - 回転周期の検出と予測

- **ビタ押し予測機能**
  - 目標図柄到達タイミングの計算
  - ヒューマンディレイを考慮した補正
  - 機種ごとの特性（引き込み、すべり等）を考慮した調整

#### 2.2.4. ユーザーインターフェースモジュール
- **表示機能**
  - リアルタイム認識状況表示
  - タイミングインジケーター
  - ステータス情報表示

- **設定機能**
  - 図柄テンプレート登録・編集
  - 認識感度・領域設定
  - アラート設定

- **アラート機能**
  - 視覚的インジケーター
  - 音声通知

### 2.3. システムアーキテクチャ
- イベント駆動型アーキテクチャを採用
- モジュール間はObserverパターンで疎結合化
- 性能要件を満たすためのマルチスレッド処理

## 3. クラス設計

### 3.1. 画面キャプチャモジュール
- `ScreenCapture`: スクリーンキャプチャの基本クラス
  - `capture_frame()`: 画面フレームをキャプチャ
  - `set_capture_area()`: キャプチャ領域設定
- `VideoProcessor`: キャプチャした画像の前処理
  - `preprocess()`: 画像の前処理実行
  - `detect_reel_area()`: リール領域の自動検出

### 3.2. 図柄認識モジュール
- `SymbolRecognizer`: 図柄認識の基底クラス
  - `recognize_symbols()`: 図柄認識実行
  - `register_template()`: 新規テンプレート登録
- `TemplateMatching`: テンプレートマッチングによる認識
  - `match_template()`: テンプレートマッチング実行
- `SymbolTracker`: 認識済み図柄のトラッキング
  - `track_symbols()`: 図柄位置追跡
  - `predict_movement()`: 動き予測

### 3.3. タイミング計算モジュール
- `ReelAnalyzer`: リール回転の解析
  - `calculate_speed()`: 回転速度計算
  - `detect_cycle()`: 回転周期検出
- `TimingPredictor`: ビタ押しタイミング予測
  - `predict_timing()`: 最適タイミング予測
  - `adjust_for_machine()`: 機種別補正

### 3.4. ユーザーインターフェースモジュール
- `MainWindow`: メインウィンドウUI
  - `update_display()`: 表示更新
  - `show_timing_indicator()`: タイミング表示
- `SettingsDialog`: 設定ダイアログ
  - `save_settings()`: 設定保存
  - `load_settings()`: 設定読み込み
- `AlertManager`: アラート管理
  - `trigger_alert()`: アラート発動
  - `configure_alerts()`: アラート設定

### 3.5. 統合クラス
- `SlotAnalyzer`: システム全体の統合・制御
  - `start_analysis()`: 解析開始
  - `stop_analysis()`: 解析停止
  - `configure_system()`: システム設定

## 4. データ設計

### 4.1. 設定データ
- JSON形式で保存
- ユーザー設定、機種情報、図柄テンプレートを含む

### 4.2. 図柄テンプレートデータ
- 画像ファイル（PNG形式）
- メタデータ（JSON）
  - 図柄名
  - 基準位置情報
  - マッチングパラメータ

### 4.3. 機種データ
- JSON形式で保存
- リール配列情報
- 引き込み/すべり特性情報
- 固有パラメータ

## 5. インターフェース設計

### 5.1. モジュール間インターフェース
- イベントベースの通信
- 各モジュールはObserver/Observableパターンを実装

### 5.2. ユーザーインターフェース
- PyQt5/PySide2を使用したGUIの実装
- リアルタイム情報表示とコントロールパネル
- タイミングインジケーターの視覚的デザイン

## 6. 実装計画

### 6.1. フェーズ1: 基本機能実装
- 画面キャプチャモジュール
- 基本的な図柄認識（テンプレートマッチング）
- シンプルなUI

### 6.2. フェーズ2: 高度機能実装
- タイミング計算アルゴリズム
- 図柄トラッキング機能
- 高度なUI機能

### 6.3. フェーズ3: 最適化と拡張
- 性能最適化
- 複数機種対応
- ユーザーフィードバックに基づく改良

## 7. 検討事項・リスク

### 7.1. 技術的課題
- 動画再生環境によるフレームレートの不安定性
- 異なる解像度やリールデザインへの対応
- 低遅延処理の実現

### 7.2. 対策
- アダプティブなフレームレート調整機能
- 機械学習によるロバスト性向上
- パフォーマンス最適化（Cython、マルチスレッド等）
