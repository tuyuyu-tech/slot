# パチスロ動画ビタ押しタイミング認識システム 設計書

## 1. 要件定義書

### 1.1. 目的
パチスロ動画においてリール上の特定図柄を認識し、最適なビタ押しタイミングをユーザーに提示するシステムを開発する。

### 1.2. 機能要件
1. **画面キャプチャ機能**
   - 動画再生画面をリアルタイムでキャプチャする
   - フレームレートを安定させ、遅延を最小限に抑える
   - 自動キャリブレーションによりリール領域を自動検出する

2. **図柄認識機能**
   - リール上の特定図柄を認識する
   - 複数の図柄を同時に認識・追跡できる
   - 異なる機種・解像度に対応できる
   - テンプレートマッチングと機械学習のハイブリッド検出により高精度認識を実現

3. **タイミング計算機能**
   - リールの回転速度と位置を計算する
   - 目標図柄に対する最適なボタン押下タイミングを予測する
   - 機種ごとの特性（引き込み・すべり等）を考慮した補正を行う

4. **ユーザーインターフェース**
   - 認識された図柄とタイミング情報をリアルタイムで表示
   - 視覚的・音声的アラートによるタイミング通知
   - 図柄登録、感度調整などの設定画面提供
   - 使いやすいキャリブレーションUIの提供

### 1.3. 非機能要件
1. **性能要件**
   - 30fps以上での処理速度確保
   - ビタ押しタイミングの精度±1フレーム以内
   - CPU使用率30%以下の軽量処理

2. **互換性要件**
   - Windows 10/11環境での動作保証
   - 主要な動画プレーヤー・配信サイトとの互換性

3. **拡張性要件**
   - 新機種対応のためのプラグイン式アーキテクチャ
   - ユーザーによる図柄テンプレート登録機能

## 2. システム設計書

### 2.1. システム概要
本システムは4つの主要モジュールから構成される：
1. 画面キャプチャモジュール
2. 図柄認識モジュール
3. タイミング計算モジュール
4. ユーザーインターフェースモジュール

これらのモジュールが連携し、リアルタイムでパチスロ動画を解析し、ビタ押しタイミングを通知する。

### 2.2. 機能詳細設計

#### 2.2.1. 画面キャプチャモジュール
- **スクリーンキャプチャ機能**
  - Win32 APIまたはDirectXを使用したスクリーンキャプチャ
  - 指定された領域のみをキャプチャする機能
  - フレームレート調整とバッファリング機能

- **プリプロセッシング機能**
  - 解像度統一・ノイズ削減等の前処理
  - リール領域の自動検出と切り出し

#### 2.2.2. 図柄認識モジュール
- **テンプレートマッチング機能**
  - 事前登録された図柄テンプレートとのマッチング
  - スケーリング・回転に対応したマッチングアルゴリズム

- **機械学習認識機能（オプション）**
  - CNNによる図柄認識
  - 学習モデルの保存と読み込み

- **トラッキング機能**
  - 認識された図柄の位置追跡
  - オプティカルフロー等を用いた動き予測

#### 2.2.3. タイミング計算モジュール
- **回転解析機能**
  - フレーム間の変化量からリール回転速度算出
  - 回転周期の検出と予測

- **ビタ押し予測機能**
  - 目標図柄到達タイミングの計算
  - ヒューマンディレイを考慮した補正
  - 機種ごとの特性（引き込み、すべり等）を考慮した調整

### 2.2.4. 機種管理モジュール
- **機種データベース管理機能**
  - 機種情報の登録・編集・削除
  - リール配列データの保存・読み込み
  - 機種ごとの特性パラメータの管理

- **機種自動判別機能**
  - 画像特徴に基づく機種判別
  - 機械学習モデルの学習・保存・読み込み
  - 自動判別に基づく機種切り替え

#### 2.2.5. ユーザーインターフェースモジュール
- **表示機能**
  - リアルタイム認識状況表示
  - タイミングインジケーター
  - ステータス情報表示

- **設定機能**
  - 図柄テンプレート登録・編集
  - 認識感度・領域設定
  - アラート設定

- **アラート機能**
  - 視覚的インジケーター
  - 音声通知

### 2.3. システムアーキテクチャ
- イベント駆動型アーキテクチャを採用
- モジュール間はObserverパターンで疎結合化
- 性能要件を満たすためのマルチスレッド処理

## 3. クラス設計

### 3.1. 画面キャプチャモジュール
- `ScreenCapture`: スクリーンキャプチャの基本クラス
  - `capture_frame()`: 画面フレームをキャプチャ
  - `set_capture_area()`: キャプチャ領域設定
- `VideoProcessor`: キャプチャした画像の前処理
  - `preprocess()`: 画像の前処理実行
  - `detect_reel_area()`: リール領域の自動検出
- `ReelCalibrator`: リール領域の自動キャリブレーション
  - `detect_reel_area()`: リール領域を検出
  - `detect_reel_divisions()`: リールの分割位置を検出
  - `calibrate()`: 複数フレームを使用してキャリブレーション
- `AutoCalibrationDialog`: 自動キャリブレーションを実行するダイアログ
  - `start_calibration()`: キャリブレーションプロセスを開始
  - `add_calibration_frame()`: キャリブレーション用フレームを追加
  - `finish_calibration()`: キャリブレーションを完了

### 3.2. 図柄認識モジュール
- `SymbolRecognizer`: 図柄認識の基底クラス
  - `recognize_symbols()`: 図柄認識実行
  - `register_template()`: 新規テンプレート登録
- `TemplateMatching`: テンプレートマッチングによる認識
  - `match_template()`: テンプレートマッチング実行
- `MLSymbolRecognizer`: 機械学習を用いた図柄認識
  - `train_model()`: モデルの学習
  - `sliding_window()`: スライディングウィンドウ検出
- `HybridSymbolRecognizer`: テンプレートマッチングと機械学習を組み合わせた認識
  - `_merge_results()`: 複数手法の結果を統合
- `SymbolTracker`: 認識済み図柄のトラッキング
  - `track_symbols()`: 図柄位置追跡
  - `predict_movement()`: 動き予測

### 3.3. タイミング計算モジュール
- `ReelAnalyzer`: リール回転の解析
  - `calculate_speed()`: 回転速度計算
  - `detect_cycle()`: 回転周期検出
- `TimingPredictor`: ビタ押しタイミング予測
  - `predict_timing()`: 最適タイミング予測
  - `adjust_for_machine()`: 機種別補正

### 3.4. ユーザーインターフェースモジュール
- `MainWindow`: メインウィンドウUI
  - `update_display()`: 表示更新
  - `show_timing_indicator()`: タイミング表示
  - `show_auto_calibration_dialog()`: 自動キャリブレーションダイアログを表示
- `CalibrationDialog`: 自動キャリブレーションダイアログ
  - `start_calibration()`: キャリブレーション開始
  - `apply_calibration()`: キャリブレーション結果を適用
- `SettingsDialog`: 設定ダイアログ
  - `save_settings()`: 設定保存
  - `load_settings()`: 設定読み込み
- `AlertManager`: アラート管理
  - `trigger_alert()`: アラート発動
  - `configure_alerts()`: アラート設定

### 3.5. 機種管理モジュール
- `MachineDatabase`: 機種データベースを管理するクラス
  - `load_machines()`: 機種データを読み込み
  - `save_machines()`: 機種データを保存
  - `add_machine()`: 機種を追加
  - `remove_machine()`: 機種を削除
  - `get_machine()`: 機種データを取得
  - `store_reel_array()`: リール配列を保存
  - `detect_machine()`: 機種を自動判別
- `MachineDetector`: 機種自動判別を行うクラス
  - `train()`: モデルを学習
  - `detect()`: フレームから機種を判別
- `MachineDialog`: 機種データ管理用のダイアログクラス
  - 機種一覧表示・編集
  - 新規機種追加
  - リール配列設定
  - 機種判別学習

### 3.6. 統合クラス
- `SlotAnalyzer`: システム全体の統合・制御
  - `start_analysis()`: 解析開始
  - `stop_analysis()`: 解析停止
  - `configure_system()`: システム設定

## 4. データ設計

### 4.1. 設定データ
- JSON形式で保存
- ユーザー設定、機種情報、図柄テンプレートを含む

### 4.2. 図柄テンプレートデータ
- 画像ファイル（PNG形式）
- メタデータ（JSON）
  - 図柄名
  - 基準位置情報
  - マッチングパラメータ

### 4.3. 機種データ
- JSON形式で保存（machines.json）
- 機種ごとの設定：
  - 名前と追加日時
  - すべりフレーム数
  - 引き込み範囲
  - ボタン押下から停止までのフレーム数
  - リール配列情報
  - 視覚的特徴データ（機種判別用）

### 4.4. 機種判別モデル
- 機械学習モデル（SVM）
- joblib形式で保存
- 視覚的特徴から機種を判別

## 5. インターフェース設計

### 5.1. モジュール間インターフェース
- イベントベースの通信
- 各モジュールはObserver/Observableパターンを実装

### 5.2. ユーザーインターフェース
- PyQt5/PySide2を使用したGUIの実装
- リアルタイム情報表示とコントロールパネル
- タイミングインジケーターの視覚的デザイン

## 6. 実装計画

### 6.1. フェーズ1: 基本機能実装 [完了]
- 画面キャプチャモジュール
- 基本的な図柄認識（テンプレートマッチング）
- シンプルなUI

### 6.2. フェーズ2: 高度機能実装 [完了]
- タイミング計算アルゴリズム
- 図柄トラッキング機能
- 高度なUI機能

### 6.3. フェーズ3: 最適化と拡張 [進行中]
- 機械学習を利用した高精度認識機能 [完了]
  - HOG特徴量とSVMを用いた機械学習認識
  - テンプレートマッチングとのハイブリッドアプローチ
- 自動キャリブレーション機能 [完了]
  - リール領域の自動検出
  - リール分割位置の検出
  - UIによる簡単なセットアップ
- 複数機種対応拡張 [完了]
  - 機種データベース管理機能
  - 機種ごとの特性（すべり・引き込み等）の設定
  - 機種自動判別機能（機械学習ベース）
  - リール配列データの管理
- 性能最適化 [予定]
- ユーザーフィードバックに基づく改良 [予定]

## 7. 検討事項・リスク

### 7.1. 技術的課題
- 動画再生環境によるフレームレートの不安定性
- 異なる解像度やリールデザインへの対応
- 低遅延処理の実現
- 機械学習モデルの学習データ不足

### 7.2. 対策
- アダプティブなフレームレート調整機能
- 機械学習とテンプレートマッチングのハイブリッドアプローチ
- 自動キャリブレーションによるセットアップ簡易化
- データ拡張による学習精度向上
- パフォーマンス最適化（Cython、マルチスレッド等）