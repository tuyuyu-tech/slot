# 複数機種対応拡張 実装ドキュメント

## 1. 概要

パチスロ動画ビタ押しタイミング認識システムにおいて、複数の機種に対応するための拡張機能を実装しました。
この拡張により、異なる機種ごとの特性（すべりや引き込み等）を管理し、適切なタイミング予測が可能になります。
また、画面の特徴から機種を自動判別する機能も追加されています。

## 2. 実装機能

### 2.1. 機種データベース管理

- 機種情報の登録・編集・削除機能
  - 機種名
  - すべりフレーム数の設定
  - 引き込み範囲の設定
  - ボタン押下から停止までのフレーム数の設定
  - 追加日時の記録

- リール配列データの管理
  - 各リール（最大3リール）の図柄配列を保存
  - カンマ区切りテキストでの入力に対応

- 機種データのシリアライズ/デシリアライズ
  - JSON形式での保存
  - 起動時の自動読み込み

### 2.2. 機種自動判別機能

- 画面特徴に基づく機種判別
  - 画像特徴抽出（ヒストグラム特徴、エッジ特徴）
  - SVM分類器による機種判別

- 機種判別用学習機能
  - 特徴サンプルの追加・管理
  - モデル学習と保存
  - 再利用可能なモデルファイル

- 自動切り替え機能
  - 判別された機種に基づく自動設定切り替え
  - 機種判別頻度の制御（5秒間隔）
  - 判別信頼度に基づくフィルタリング

### 2.3. ユーザーインターフェース

- 機種管理ダイアログ
  - 機種一覧表示・編集タブ
  - 新規機種追加タブ
  - リール配列設定タブ
  - 機種判別学習タブ

- メイン画面の機能拡張
  - 機種管理ボタンの追加
  - 自動機種判別の有効/無効切り替え
  - ステータスバーでの判別情報表示

## 3. クラス構造

### 3.1. 機種管理モジュール（src/machine/）

- `MachineDatabase`：機種データベースの管理クラス
  - 機種データの保存・読み込み
  - 機種の追加・削除・更新
  - リール配列の管理
  - 機種自動判別の統合

- `MachineDetector`：機種自動判別クラス
  - 画像特徴抽出
  - モデル学習・保存・読み込み
  - フレームからの機種判別

### 3.2. UI拡張（src/ui/）

- `MachineDialog`：機種管理ダイアログ
  - 機種一覧・編集機能
  - 新規機種追加フォーム
  - リール配列入力UI
  - 機種判別学習UI

- `MainWindow`拡張
  - 機種管理との統合
  - 自動判別機能の統合

## 4. データ構造

### 4.1. 機種データ（JSON）

```json
{
  "machine_name": {
    "name": "機種名",
    "slip_frames": 1,
    "pull_in_range": 3,
    "button_to_stop_frames": 2,
    "added_date": "2023-01-01 00:00:00",
    "reel_array": [
      ["7", "BAR", "ベル", "スイカ"],
      ["BAR", "7", "スイカ", "ベル"],
      ["ベル", "スイカ", "7", "BAR"]
    ],
    "visual_features": {
      "general": [[特徴1], [特徴2], ...],
      "title": [[特徴1], [特徴2], ...],
      "gameplay": [[特徴1], [特徴2], ...]
    }
  }
}
```

### 4.2. 機種判別モデル（joblib）

- SVMモデル
- 特徴スケーラー
- 学習データ情報

## 5. 使用方法

1. 機種管理
   - メイン画面の「機種管理」ボタンをクリック
   - 「新規機種追加」タブで機種を登録
   - 「リール配列設定」タブでリール配列を登録

2. 機種判別学習
   - 「機種判別学習」タブで機種を選択
   - 表示されているフレームで「特徴サンプル追加」を実行
   - 複数のサンプルを追加後、「機種判別モデルを学習」をクリック

3. 自動判別設定
   - メイン画面の「自動機種判別」チェックボックスをオン/オフ

## 6. 今後の課題

1. 性能最適化
   - 判別処理の高速化
   - より精度の高い特徴抽出手法の検討
   - マルチスレッド化（UIの応答性向上）

2. 機能拡張
   - より詳細な機種固有設定の追加
   - 機種判別精度向上のためのデータ拡張
   - 機種ごとの図柄セット管理

3. ユーザビリティ向上
   - 判別信頼度の視覚的表示
   - 機種プリセットの提供
   - 学習データのインポート/エクスポート機能

## 7. 結論

複数機種対応拡張の実装により、パチスロ動画ビタ押しタイミング認識システムの汎用性が大幅に向上しました。
異なる機種の特性を考慮した精度の高いタイミング予測が可能になり、また自動判別機能によりユーザーの手間も削減されています。
今後は判別精度の向上と性能最適化を進めることで、さらに使いやすいシステムへと発展させていきます。
